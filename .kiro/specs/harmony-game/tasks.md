# 实施计划: 和声游戏

## 概述

本实施计划将和声游戏的设计转化为可执行的开发任务。我们将采用增量开发方式，从核心音乐理论模型开始，逐步构建规则验证引擎、游戏逻辑层，最后完成用户界面。每个任务都建立在前面任务的基础上，确保代码始终处于可集成状态。

## 任务

- [x] 1. 项目初始化和核心数据模型
  - 使用 Vite 创建 React + TypeScript 项目
  - 安装依赖：VexFlow, Vitest, fast-check
  - 创建核心数据类型：Note, Chord, ChordProgression
  - _需求: 2.3, 10.1_

- [x] 1.1 为核心数据模型编写单元测试
  - 测试 Note, Chord, ChordProgression 的创建和基本操作
  - _需求: 2.3_

- [x] 2. 实现音乐理论工具函数
  - [x] 2.1 实现音程计算函数
    - 计算两个音符之间的音程（如完全五度、八度）
    - 处理不同八度的音符
    - _需求: 3.4_

  - [x] 2.2 为音程计算编写属性测试
    - **属性 7: 平行五度检测正确性**
    - **属性 8: 平行八度检测正确性**
    - **验证需求: 3.4**

  - [x] 2.3 实现声部范围验证
    - 定义每个声部的合理音域（女高音、女低音、男高音、男低音）
    - 验证音符是否在声部范围内
    - _需求: 3.4_

  - [x] 2.4 实现和弦有效性检查
    - 验证四个音符是否构成有效和弦
    - 检查音符是否符合和弦结构
    - _需求: 2.4_

  - [x] 2.5 为和弦有效性编写属性测试
    - **属性 12: 音符输入验证**
    - **验证需求: 2.4**

- [x] 3. 实现规则验证引擎核心
  - [x] 3.1 创建 ValidationRule 接口和 ValidationResult 类型
    - 定义规则的数据结构
    - 定义验证结果和错误的数据结构
    - _需求: 3.1, 4.1, 4.2, 4.3_

  - [x] 3.2 实现 RuleEngine 类
    - 实现规则注册和管理
    - 实现按章节加载规则
    - 实现验证和弦进行的主逻辑
    - _需求: 3.1, 3.5, 9.1, 9.3_

  - [x] 3.3 为 RuleEngine 编写属性测试
    - **属性 1: 规则验证完整性**
    - **属性 6: 规则累积性**
    - **属性 16: 规则应用顺序一致性**
    - **验证需求: 3.1, 3.5, 9.2, 9.3, 9.4**

- [x] 4. 实现基础和声规则
  - [x] 4.1 实现平行五度检测规则
    - 检测任意两个声部之间的平行五度
    - 返回详细的错误信息，包括受影响的声部和和弦
    - _需求: 3.4_

  - [x] 4.2 实现平行八度检测规则
    - 检测任意两个声部之间的平行八度
    - 返回详细的错误信息
    - _需求: 3.4_

  - [x] 4.3 实现声部交叉检测规则
    - 检测相邻声部是否交叉（如女低音高于女高音）
    - _需求: 3.4_

  - [x] 4.4 实现声部超出音域检测规则
    - 检测音符是否超出声部的合理范围
    - _需求: 3.4_

  - [x] 4.5 为基础规则编写属性测试
    - **属性 7: 平行五度检测正确性**
    - **属性 8: 平行八度检测正确性**
    - **属性 9: 错误信息完整性**
    - **属性 10: 多错误同时显示**
    - **验证需求: 3.4, 4.1, 4.2, 4.3, 4.4**

- [x] 5. 检查点 - 确保核心验证引擎工作正常
  - 所有测试通过（417个测试）

- [ ] 6. 实现练习题数据管理
  - [x] 6.1 定义练习题数据格式
    - 创建 Exercise 和 ExerciseConstraints 接口
    - 设计 JSON 数据文件结构
    - _需求: 5.1, 10.1, 10.2_

  - [x] 6.2 实现 ExerciseRepository 类
    - 实现从 JSON 文件加载练习题
    - 实现按章节获取练习题
    - 实现练习题数据验证
    - _需求: 5.1, 5.2_

  - [x] 6.3 创建示例练习题数据
    - 为第1-3章创建示例练习题（每章2题）
    - 包含起始和弦、说明和参考答案
    - _需求: 5.1, 5.3_

  - [x] 6.4 为练习题数据编写属性测试
    - **属性 11: 练习题数据完整性**
    - **验证需求: 1.2, 5.1, 5.2, 10.2**

- [x] 7. 实现游戏状态管理
  - [x] 7.1 创建 GameState 接口和初始状态
    - 定义游戏状态的数据结构
    - 实现初始状态创建函数
    - _需求: 1.5, 6.1_

  - [x] 7.2 实现 GameManager 类
    - 实现关卡开始逻辑
    - 实现练习题提交和验证
    - 实现分数更新逻辑
    - 实现关卡解锁逻辑
    - _需求: 1.3, 3.2, 6.2, 6.3_

  - [x] 7.3 为游戏状态管理编写属性测试
    - **属性 2: 分数单调递增**
    - **属性 3: 错误不扣分**
    - **属性 4: 关卡解锁顺序性**
    - **验证需求: 1.3, 3.2, 6.2, 6.3**

- [x] 8. 实现数据持久化
  - [x] 8.1 实现 LocalStorage 保存和加载
    - 实现保存游戏状态到 LocalStorage
    - 实现从 LocalStorage 加载游戏状态
    - 处理数据损坏和版本兼容性
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 8.2 为数据持久化编写属性测试
    - **属性 5: 进度持久化往返一致性**
    - **验证需求: 6.5, 7.1, 7.2, 7.3, 7.4**

- [x] 9. 检查点 - 确保游戏逻辑层完整
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 实现五线谱渲染组件
  - [x] 10.1 创建 StaffNotation 组件
    - 使用 VexFlow 渲染和弦进行
    - 支持高亮显示特定音符
    - 处理不同数量的和弦
    - _需求: 2.2, 8.1_

  - [x] 10.2 为五线谱渲染编写属性测试
    - **属性 15: 五线谱渲染包含性**
    - **验证需求: 2.2**

  - [x] 10.3 创建 ErrorDisplay 组件
    - 显示验证错误列表
    - 高亮显示错误相关的音符
    - 显示章节引用和错误说明
    - _需求: 4.1, 4.2, 4.3, 4.4_

- [x] 11. 实现音符输入界面
  - [x] 11.1 创建 NoteInput 组件
    - 提供音符选择界面（音高和八度）
    - 支持四个声部的输入
    - 实时验证音符有效性
    - _需求: 2.1, 2.3, 2.4_

  - [x] 11.2 实现音符编辑功能
    - 支持点击音符进行编辑
    - 支持删除音符
    - _需求: 2.5_

  - [x] 11.3 为音符编辑编写属性测试
    - **属性 13: 音符编辑幂等性**
    - **验证需求: 2.5**

- [x] 12. 实现练习题界面
  - [x] 12.1 创建 ExerciseView 组件
    - 显示练习题说明和编号
    - 显示起始和弦
    - 集成五线谱渲染和音符输入
    - 提供提交按钮
    - _需求: 5.3, 8.2_

  - [x] 12.2 实现练习题约束执行
    - 根据练习题约束限制可用和弦
    - 显示约束提示
    - _需求: 5.4_

  - [x] 12.3 为练习题约束编写属性测试
    - **属性 14: 练习题约束执行**
    - **验证需求: 5.4**

  - [x] 12.4 实现答案显示功能
    - 在完成或跳过后显示参考答案
    - _需求: 5.5_

- [x] 13. 实现关卡选择界面
  - [x] 13.1 创建 LevelSelector 组件
    - 显示所有60个关卡
    - 显示锁定/解锁状态
    - 显示完成状态
    - 显示章节标题
    - _需求: 1.1, 1.4, 8.5_

  - [x] 13.2 实现关卡导航
    - 点击关卡进入练习
    - 在练习题之间导航
    - _需求: 8.4_

- [x] 14. 实现主游戏界面
  - [x] 14.1 创建 GameView 组件
    - 集成关卡选择、练习题视图和分数显示
    - 实现游戏流程控制
    - _需求: 6.4, 8.3_

  - [x] 14.2 实现 React Context 状态管理
    - 创建 GameContext 提供全局游戏状态
    - 连接 GameManager 和 UI 组件
    - _需求: 6.1_

  - [x] 14.3 实现自动保存功能
    - 在关键操作后自动保存进度
    - 在应用启动时加载进度
    - _需求: 6.5, 7.1, 7.2_

- [x] 15. 集成测试和完善
  - [x] 15.1 编写端到端集成测试
    - 测试完整的游戏流程
    - 测试跨会话的进度保存
    - _需求: 所有需求_

  - [x] 15.2 添加错误处理和用户反馈
    - 处理数据加载失败
    - 处理 LocalStorage 不可用
    - 提供友好的错误消息
    - _需求: 4.5_

  - [x] 15.3 优化和性能调整
    - 优化 VexFlow 渲染性能
    - 优化规则验证性能
    - _需求: 所有需求_

- [ ] 16. 最终检查点
  - 确保所有测试通过，确认应用可以正常运行

- [ ] 17. 扩展练习题内容
  - [ ] 17.1 添加第4-10章练习题
    - 为每章创建2个练习题
    - 包含起始和弦、说明和参考答案
    - 确保练习题符合对应章节的规则
    - _需求: 5.1, 5.3_

  - [ ] 17.2 验证新练习题数据
    - 运行属性测试确保数据完整性
    - 手动测试每个练习题
    - _需求: 5.1, 5.2_

- [ ] 18. 实现音频播放功能
  - [ ] 18.1 集成音频库
    - 选择合适的音频库（如 Tone.js）
    - 实现音符播放功能
    - _需求: 8.3_

  - [ ] 18.2 实现和弦播放
    - 实现同时播放多个音符
    - 实现和弦进行播放
    - 添加播放控制按钮
    - _需求: 8.3_

  - [ ] 18.3 添加音频设置
    - 实现音量控制
    - 实现音色选择
    - 实现播放速度控制
    - _需求: 8.3_

## 注意事项

- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有任务都是必需的，以确保从一开始就有全面的测试覆盖

