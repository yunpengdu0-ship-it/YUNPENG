# 测试和开发计划

## 概述

本文档描述了接下来的开发和测试步骤，包括：
1. 运行应用测试所有功能
2. 修复已知的测试失败
3. 添加更多练习题内容（4-10章）
4. 实现音频播放功能

---

## 步骤 1: 运行应用测试所有功能

### 1.1 启动开发服务器

由于你的系统在 PowerShell 中 npm 不可用，请使用 cmd：

```cmd
npm run dev
```

应用将在浏览器中自动打开，地址为: http://localhost:5173/

### 1.2 功能测试清单

#### 基础功能测试
- [ ] **应用启动**: 应用正常加载，显示关卡选择界面
- [ ] **进度加载**: 如果有保存的进度，应该自动加载
- [ ] **关卡显示**: 60个关卡正确显示，状态颜色正确

#### 关卡选择测试
- [ ] **第一关解锁**: 第一关应该是蓝色（已解锁）
- [ ] **其他关卡锁定**: 其他关卡应该是灰色（已锁定）
- [ ] **点击关卡**: 点击第一关，应该进入练习题界面
- [ ] **统计面板**: 显示正确的统计数据

#### 练习题界面测试
- [ ] **练习题加载**: 练习题信息正确显示
- [ ] **五线谱渲染**: 起始和弦在五线谱上正确显示
- [ ] **和弦编辑器**: 和弦编辑器正确显示起始和弦

#### 音符编辑测试
- [ ] **点击和弦**: 点击和弦，音符输入面板出现
- [ ] **编辑音符**: 可以修改音高、变音记号、八度
- [ ] **声部范围验证**: 超出范围的音符显示警告
- [ ] **确认编辑**: 点击确认，和弦更新
- [ ] **五线谱更新**: 五线谱实时更新显示新的音符

#### 和弦操作测试
- [ ] **添加和弦**: 点击 "+"，可以添加新和弦
- [ ] **删除和弦**: 点击 "×"，可以删除和弦
- [ ] **编辑多个和弦**: 可以编辑多个和弦

#### 验证测试
- [ ] **提交正确答案**: 提交正确的和弦进行，显示成功消息
- [ ] **提交错误答案**: 提交错误的和弦进行，显示错误列表
- [ ] **错误显示**: 错误信息清晰，包含规则名称、说明、受影响的声部
- [ ] **点击错误**: 点击错误，相关音符高亮显示

#### 答案功能测试
- [ ] **显示答案**: 点击"显示答案"，参考答案显示在五线谱上
- [ ] **隐藏答案**: 再次点击，答案隐藏

#### 完成和导航测试
- [ ] **完成练习题**: 提交正确答案后，练习题标记为完成
- [ ] **分数更新**: 分数正确增加
- [ ] **关卡解锁**: 下一关自动解锁
- [ ] **返回关卡选择**: 点击"返回"，回到关卡选择界面
- [ ] **完成状态**: 已完成的关卡显示为绿色

#### 进度保存测试
- [ ] **自动保存**: 完成练习题后，进度自动保存
- [ ] **刷新页面**: 刷新页面，进度保持
- [ ] **关闭浏览器**: 关闭并重新打开浏览器，进度保持

#### 跳过功能测试
- [ ] **跳过练习题**: 点击"跳过"，确认后返回关卡选择
- [ ] **跳过不解锁**: 跳过的练习题不解锁下一关
- [ ] **跳过不得分**: 跳过的练习题不增加分数

### 1.3 测试结果记录

请在测试过程中记录：
1. 所有通过的功能 ✅
2. 发现的问题 ❌
3. 改进建议 💡

---

## 步骤 2: 修复已知的测试失败

### 2.1 运行测试套件

在新的 cmd 窗口中运行：

```cmd
npm test
```

### 2.2 已知的测试失败（21个）

根据之前的分析，测试失败分为以下几类：

#### 类别 1: 音高格式问题（5个）
**问题**: 音符字符串格式不一致
**影响文件**: 
- `src/core/musicUtils.test.ts`
- `src/core/intervals.test.ts`

**修复策略**:
1. 统一音符字符串格式（如 "C4" vs "C/4"）
2. 更新测试用例使用正确的格式
3. 确保所有模块使用相同的格式约定

#### 类别 2: 声部范围问题（8个）
**问题**: 声部范围定义不一致
**影响文件**:
- `src/core/voiceRanges.test.ts`
- `src/core/chordValidation.test.ts`

**修复策略**:
1. 检查声部范围定义是否符合实际需求
2. 更新测试用例使用正确的范围
3. 确保 UI 和验证逻辑使用相同的范围

#### 类别 3: 关卡解锁逻辑（5个）
**问题**: 解锁条件边界情况
**影响文件**:
- `src/game/GameManager.test.ts`

**修复策略**:
1. 检查解锁逻辑的边界条件
2. 更新测试用例反映正确的解锁规则
3. 确保 UI 显示与逻辑一致

#### 类别 4: 其他边界情况（3个）
**问题**: 各种边界情况处理
**影响文件**: 多个测试文件

**修复策略**:
1. 逐个分析失败原因
2. 修复代码或更新测试
3. 确保边界情况正确处理

### 2.3 修复优先级

**高优先级**（影响核心功能）:
1. 关卡解锁逻辑问题
2. 声部范围问题（如果影响 UI）

**中优先级**（影响测试覆盖）:
3. 音高格式问题
4. 声部范围问题（如果仅影响测试）

**低优先级**（边界情况）:
5. 其他边界情况

---

## 步骤 3: 添加更多练习题内容（4-10章）

### 3.1 当前状态

目前只有 3 章的练习题数据（6个练习题）：
- 第1章: 三和弦的连接（2题）
- 第2章: 和弦的转位（2题）
- 第3章: 属七和弦（2题）

### 3.2 需要添加的内容

需要为第 4-10 章添加练习题（每章2题，共14题）：

#### 第4章: 属七和弦的转位
- 练习题 4-1: 属七和弦第一转位
- 练习题 4-2: 属七和弦第二转位

#### 第5章: 副属和弦
- 练习题 5-1: 副属和弦的使用
- 练习题 5-2: 副属和弦的连接

#### 第6章: 减七和弦
- 练习题 6-1: 减七和弦的引入
- 练习题 6-2: 减七和弦的解决

#### 第7章: 二级和弦
- 练习题 7-1: 二级和弦的使用
- 练习题 7-2: 二级和弦的连接

#### 第8章: 六级和弦
- 练习题 8-1: 六级和弦的使用
- 练习题 8-2: 六级和弦的连接

#### 第9章: 三级和弦
- 练习题 9-1: 三级和弦的使用
- 练习题 9-2: 三级和弦的连接

#### 第10章: 和弦外音
- 练习题 10-1: 经过音和辅助音
- 练习题 10-2: 倚音和换音

### 3.3 练习题数据格式

每个练习题需要包含：

```json
{
  "id": "4-1",
  "chapter": 4,
  "title": "第4章: 属七和弦的转位",
  "description": "练习属七和弦第一转位的使用",
  "startingChord": {
    "soprano": { "pitch": "C", "accidental": "natural", "octave": 5 },
    "alto": { "pitch": "E", "accidental": "natural", "octave": 4 },
    "tenor": { "pitch": "G", "accidental": "natural", "octave": 3 },
    "bass": { "pitch": "C", "accidental": "natural", "octave": 3 }
  },
  "constraints": {
    "requiredChords": [],
    "forbiddenChords": [],
    "minLength": 4,
    "maxLength": 8
  },
  "solution": [
    // 参考答案
  ],
  "hints": [
    "注意属七和弦的解决",
    "第一转位的低音是三音"
  ]
}
```

### 3.4 实施步骤

1. **研究教材内容**: 了解每章的重点和难点
2. **设计练习题**: 为每章设计2个有代表性的练习题
3. **编写起始和弦**: 选择合适的起始和弦
4. **设置约束条件**: 根据章节内容设置约束
5. **提供参考答案**: 编写符合规则的参考答案
6. **添加提示**: 为每个练习题添加学习提示
7. **更新数据文件**: 将新练习题添加到 `public/data/exercises.json`
8. **测试验证**: 测试新练习题是否正常工作

---

## 步骤 4: 实现音频播放功能

### 4.1 功能需求

实现和弦的音频播放功能，让用户可以听到和弦的声音：

#### 基本功能
- [ ] 播放单个和弦
- [ ] 播放整个和弦进行
- [ ] 播放参考答案
- [ ] 暂停/停止播放

#### 高级功能
- [ ] 调整播放速度
- [ ] 调整音量
- [ ] 选择音色（钢琴、管风琴等）
- [ ] 循环播放

### 4.2 技术方案

#### 方案 1: Web Audio API（推荐）
**优点**:
- 浏览器原生支持
- 性能好
- 灵活性高

**缺点**:
- 需要自己生成音频波形
- 实现复杂度较高

**实现步骤**:
1. 创建 AudioContext
2. 为每个音符生成振荡器
3. 设置音高和音量
4. 控制播放时间

#### 方案 2: Tone.js（推荐）
**优点**:
- 专为音乐应用设计
- API 简单易用
- 支持多种音色

**缺点**:
- 需要额外的依赖
- 包体积较大

**实现步骤**:
1. 安装 Tone.js: `npm install tone`
2. 创建 Synth 或 PolySynth
3. 使用 triggerAttackRelease 播放音符
4. 使用 Transport 控制时间

#### 方案 3: MIDI.js
**优点**:
- 支持 MIDI 音色
- 音质较好

**缺点**:
- 需要加载音色文件
- 初始化较慢

### 4.3 推荐实现方案

使用 **Tone.js**，因为：
1. API 简单，易于集成
2. 专为音乐应用设计
3. 社区活跃，文档完善
4. 支持多种音色和效果

### 4.4 实施步骤

#### 4.4.1 安装依赖
```cmd
npm install tone
npm install --save-dev @types/tone
```

#### 4.4.2 创建音频播放模块

创建 `src/audio/AudioPlayer.ts`:

```typescript
import * as Tone from 'tone';
import { Chord, ChordProgression } from '../types/music';

export class AudioPlayer {
  private synth: Tone.PolySynth;
  
  constructor() {
    this.synth = new Tone.PolySynth(Tone.Synth).toDestination();
  }
  
  // 播放单个和弦
  async playChord(chord: Chord, duration: number = 1): Promise<void> {
    // 实现
  }
  
  // 播放和弦进行
  async playProgression(progression: ChordProgression): Promise<void> {
    // 实现
  }
  
  // 停止播放
  stop(): void {
    // 实现
  }
}
```

#### 4.4.3 集成到 UI

在 `ExerciseView` 组件中添加播放按钮：

```typescript
// 添加播放按钮
<button onClick={handlePlayProgression}>
  🔊 播放
</button>

<button onClick={handlePlaySolution}>
  🔊 播放答案
</button>
```

#### 4.4.4 实现播放逻辑

```typescript
const handlePlayProgression = async () => {
  await audioPlayer.playProgression(currentProgression);
};

const handlePlaySolution = async () => {
  if (exercise.solution) {
    await audioPlayer.playProgression(exercise.solution);
  }
};
```

#### 4.4.5 添加播放控制

```typescript
// 播放状态
const [isPlaying, setIsPlaying] = useState(false);

// 播放控制
const handlePlay = async () => {
  setIsPlaying(true);
  await audioPlayer.playProgression(currentProgression);
  setIsPlaying(false);
};

const handleStop = () => {
  audioPlayer.stop();
  setIsPlaying(false);
};
```

#### 4.4.6 添加音色选择

```typescript
// 音色选项
const instruments = [
  { value: 'piano', label: '钢琴' },
  { value: 'organ', label: '管风琴' },
  { value: 'strings', label: '弦乐' }
];

// 切换音色
const handleInstrumentChange = (instrument: string) => {
  audioPlayer.setInstrument(instrument);
};
```

### 4.5 测试清单

- [ ] 播放单个和弦，声音正确
- [ ] 播放和弦进行，时间正确
- [ ] 播放参考答案，声音正确
- [ ] 停止播放功能正常
- [ ] 音色切换功能正常
- [ ] 音量控制功能正常
- [ ] 播放速度控制功能正常

---

## 开发顺序建议

### 第一阶段（立即开始）
1. ✅ 运行应用测试所有功能
2. 📝 记录测试结果和发现的问题

### 第二阶段（根据测试结果）
3. 🔧 修复影响核心功能的测试失败
4. 🔧 修复影响用户体验的问题

### 第三阶段（内容扩展）
5. 📚 添加第 4-10 章的练习题内容
6. ✅ 测试新练习题

### 第四阶段（功能增强）
7. 🔊 实现音频播放功能
8. ✅ 测试音频播放

---

## 预期时间

- **步骤 1**: 30-60 分钟（测试）
- **步骤 2**: 2-4 小时（修复测试）
- **步骤 3**: 4-8 小时（添加练习题）
- **步骤 4**: 4-6 小时（音频播放）

**总计**: 10-18 小时

---

## 下一步行动

请按照以下顺序开始：

1. **立即**: 在 cmd 中运行 `npm run dev`，打开应用
2. **测试**: 按照功能测试清单逐项测试
3. **记录**: 记录所有发现的问题
4. **反馈**: 告诉我测试结果，我将帮助你修复问题

准备好了吗？让我们开始吧！🚀
